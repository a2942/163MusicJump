<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³ä¹é¢„è§ˆä¸è·³è½¬åˆ†äº«</title>
    <style>
        body { font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif; background: #f4f4f7; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; color: #333; }
        .main-card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); text-align: center; width: 90%; max-width: 380px; transition: 0.3s; }
        h2 { color: #e03f3f; margin: 0 0 20px 0; font-size: 20px; letter-spacing: 1px; }
        
        /* é¢„è§ˆåŒºåŸŸæ ·å¼ */
        .preview-container { 
            margin-bottom: 20px; 
            min-height: 86px; 
            background: #fafafa; 
            border-radius: 12px; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            overflow: hidden;
            border: 1px solid #eee;
        }
        .empty-preview { color: #ccc; font-size: 13px; }

        .input-group { margin-bottom: 15px; text-align: left; }
        label { display: block; font-size: 12px; color: #999; margin-bottom: 5px; padding-left: 5px; }
        input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 16px; text-align: center; outline: none; transition: 0.3s; }
        input:focus { border-color: #e03f3f; }

        .btn-stack { display: flex; flex-direction: column; gap: 8px; }
        .btn { padding: 12px; border-radius: 25px; cursor: pointer; font-weight: bold; border: none; width: 100%; transition: 0.2s; font-size: 14px; }
        .btn-main { background: #e03f3f; color: white; }
        .btn-main:hover { background: #ff5c5c; }
        .btn-outline { background: white; color: #e03f3f; border: 1px solid #e03f3f; }
        .btn-outline:hover { background: #fff5f5; }

        /* åˆ†äº«åŒºåŸŸ */
        .share-result { margin-top: 15px; padding: 12px; background: #fdfdfd; border-radius: 10px; display: none; border: 1px dashed #d33030; animation: slideDown 0.3s ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .share-url { font-size: 11px; color: #777; word-break: break-all; margin-bottom: 8px; background: #fff; padding: 6px; border-radius: 4px; border: 1px solid #eee; }

        /* å¼¹çª—æ ·å¼ */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(5px); }
        .modal-box { background: white; width: 80%; max-width: 300px; padding: 20px; border-radius: 16px; text-align: center; }
        .modal-footer { display: flex; gap: 10px; margin-top: 20px; }
        .btn-modal { flex: 1; padding: 10px; border-radius: 8px; cursor: pointer; border: none; font-weight: bold; font-size: 13px; }
        .btn-cancel { background: #eee; color: #666; }
        .btn-confirm { background: #e03f3f; color: white; }

        .status-text { margin-top: 12px; font-size: 11px; color: #bbb; height: 15px; }
    </style>
</head>
<body>

    <div class="main-card">
        <h2>ğŸµ éŸ³ä¹è¶…é“¾æ¥</h2>
        
        <!-- é¢„è§ˆæ˜¾ç¤ºåŒº -->
        <div id="previewArea" class="preview-container">
            <div class="empty-preview">è¾“å…¥ ID åè‡ªåŠ¨åŠ è½½é¢„è§ˆ</div>
        </div>

        <div class="input-group">
            <label>æ­Œæ›²æ•°å­— ID</label>
            <input type="text" id="songId" placeholder="ä¾‹å¦‚: 2619303313" oninput="handleInput(true)" onblur="handleInput(false)">
        </div>

        <div class="btn-stack">
            <button class="btn btn-main" onclick="openAskModal()">ç«‹å³æ’­æ”¾ (App)</button>
            <button class="btn btn-outline" onclick="generateShareLink()">ç”Ÿæˆåˆ†äº«é“¾æ¥</button>
        </div>

        <div id="shareArea" class="share-result">
            <div id="shareUrlText" class="share-url"></div>
            <button class="btn btn-main" style="padding: 6px; font-size: 12px; width: auto;" onclick="copyLink()">å¤åˆ¶é“¾æ¥</button>
        </div>

        <div id="status" class="status-text"></div>
    </div>

    <!-- å¼¹çª— -->
    <div id="askModal" class="modal-overlay">
        <div class="modal-box">
            <div style="font-weight: bold; margin-bottom: 10px;">ç¡®è®¤æ‰“å¼€</div>
            <div style="font-size: 13px; color: #666;">å³å°†å°è¯•å”¤èµ·ç½‘æ˜“äº‘éŸ³ä¹æ’­æ”¾</div>
            <div class="modal-footer">
                <button class="btn-modal btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn-modal btn-confirm" onclick="startProcess()">ç¡®å®š</button>
            </div>
        </div>
    </div>

<script>
    let currentId = "";
    let inputDelayTimer = null;
    let idBox = document.getElementById('songId');
    let id = "";

    // è¾“å…¥å®æ—¶å¤„ç†
    function handleInput(val) {
        document.getElementById('shareArea').style.display = 'none';
        id = idBox.value.trim();
        clearTimeout(inputDelayTimer);
        if (!val) { triggerTrueSection(id); };
        if (id && !isNaN(id)) {
            inputDelayTimer = setTimeout(() => { triggerTrueSection(id); }, 1000);
        } else {
            resetPreview();
            clearTimeout(inputDelayTimer);
        }
    }

    function triggerTrueSection(targetId) {
        if (targetId === currentId) { return; }
        currentId = targetId;
        updatePreview(targetId);
    }

    // æ›´æ–° Iframe é¢„è§ˆ
    function updatePreview(id) {
        const area = document.getElementById('previewArea');
        area.innerHTML = `<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="330" height="86" src="https://music.163.com/outchain/player?type=2&id=${id}&auto=0&height=66"></iframe>`;
    }

    function resetPreview() {
        document.getElementById('previewArea').innerHTML = `<div class="empty-preview">è¾“å…¥ ID åè‡ªåŠ¨åŠ è½½é¢„è§ˆ</div>`;
    }

    // --- åˆ†äº«é€»è¾‘ ---
    function generateShareLink() {
        const id = document.getElementById('songId').value.trim();
        if (!id || isNaN(id)) return alert("è¯·è¾“å…¥æœ‰æ•ˆ ID");
        
        const baseUrl = window.location.origin + window.location.pathname;
        const finalUrl = `${baseUrl}?id=${id}`;
        
        document.getElementById('shareUrlText').innerText = finalUrl;
        document.getElementById('shareArea').style.display = 'block';
    }

    function copyLink() {
        const url = document.getElementById('shareUrlText').innerText;
        navigator.clipboard.writeText(url).then(() => {
            const status = document.getElementById('status');
            status.innerText = "âœ… å·²å¤åˆ¶åˆ°å‰ªè´´æ¿";
            setTimeout(() => status.innerText = "", 2000);
        });
    }

    // --- è·³è½¬é€»è¾‘ ---
    function openAskModal() {
        const id = document.getElementById('songId').value.trim();
        if (!id) return;
        currentId = id;
        document.getElementById('askModal').style.display = 'flex';
    }

    function closeModal() { document.getElementById('askModal').style.display = 'none'; }

    function startProcess() {
        closeModal();
        executeJump(currentId);
    }

    function executeJump(id) {
        const statusEl = document.getElementById('status');
        const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
        
        let appUrl = isMobile ? `orpheus://song/${id}` : `orpheus://${btoa(JSON.stringify({type:"song", id:id, cmd:"play"}))}`;
        const webUrl = `https://music.163.com/#/song?id=${id}`;

        statusEl.innerText = "å°è¯•å”¤èµ·ä¸­...";
        const startTime = Date.now();
        let hasLeft = false;

        const handlePageHide = () => { hasLeft = true; };
        window.addEventListener('blur', handlePageHide, { once: true });
        window.addEventListener('visibilitychange', handlePageHide, { once: true });

        window.location.href = appUrl;

        setTimeout(() => {
            window.removeEventListener('blur', handlePageHide);
            window.removeEventListener('visibilitychange', handlePageHide);
            if (!hasLeft && (Date.now() - startTime < 3500)) {
                statusEl.innerText = "æœªæ£€æµ‹åˆ° Appï¼Œæ­£åœ¨è·³è½¬ç½‘é¡µç‰ˆ...";
                setTimeout(() => window.location.href = webUrl, 800);
            }
        }, 2500);
    }

    // åˆå§‹åŒ–
    window.onload = function() {
        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get('id');
        if (id) {
            document.getElementById('songId').value = id;
            updatePreview(id);
            currentId = id;
            setTimeout(openAskModal, 800);
        }
    };
</script>

</body>
</html>

